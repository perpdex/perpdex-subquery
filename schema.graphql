type Deposited @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "trader address"
  trader: String!
  "amount"
  amount: BigInt!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type Withdrawn @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "trader address"
  trader: String!
  "amount"
  amount: BigInt!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type InsuranceFundTransferred @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "trader address"
  trader: String!
  "amount"
  amount: BigInt!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type ProtocolFeeTransferred @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "trader address"
  trader: String!
  "amount"
  amount: BigInt!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type LiquidityAddedExchange @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "trader address"
  trader: String!
  "market address"
  market: String!
  "base"
  base: BigInt!
  "quote"
  quote: BigInt!
  "liquidity"
  liquidity: BigInt!
  "cumBasePerLiquidityX96"
  cumBasePerLiquidityX96: BigInt!
  "cumQuotePerLiquidityX96"
  cumQuotePerLiquidityX96: BigInt!
  "baseBalancePerShareX96"
  baseBalancePerShareX96: BigInt!
  "sharePriceAfterX96"
  sharePriceAfterX96: BigInt!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type LiquidityRemovedExchange @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "trader address"
  trader: String!
  "market address"
  market: String!
  "liquidator address"
  liquidator: String!
  "base"
  base: BigInt!
  "quote"
  quote: BigInt!
  "liquidity"
  liquidity: BigInt!
  "takerBase"
  takerBase: BigInt!
  "takerQuote"
  takerQuote: BigInt!
  "realizedPnl"
  realizedPnl: BigInt!
  "baseBalancePerShareX96"
  baseBalancePerShareX96: BigInt!
  "sharePriceAfterX96"
  sharePriceAfterX96: BigInt!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type PositionLiquidated @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "trader address"
  trader: String!
  "market address"
  market: String!
  "liquidator address"
  liquidator: String!
  "base"
  base: BigInt!
  "quote"
  quote: BigInt!
  "realizedPnl"
  realizedPnl: BigInt!
  "protocolFee"
  protocolFee: BigInt!
  "baseBalancePerShareX96"
  baseBalancePerShareX96: BigInt!
  "sharePriceAfterX96"
  sharePriceAfterX96: BigInt!
  "liquidationPenalty"
  liquidationPenalty: BigInt!
  "liquidationReward"
  liquidationReward: BigInt!
  "insuranceFundReward"
  insuranceFundReward: BigInt!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type PositionChanged @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "trader address"
  trader: String!
  "market address"
  market: String!
  "base"
  base: BigInt!
  "quote"
  quote: BigInt!
  "realizedPnl"
  realizedPnl: BigInt!
  "protocolFee"
  protocolFee: BigInt!
  "baseBalancePerShareX96"
  baseBalancePerShareX96: BigInt!
  "sharePriceAfterX96"
  sharePriceAfterX96: BigInt!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type MaxMarketsPerAccountChanged @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "value"
  value: Int!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type ImRatioChanged @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "value"
  value: Int!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type MmRatioChanged @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "value"
  value: Int!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type LiquidationRewardConfigChanged @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "rewardRatio"
  rewardRatio: Int!
  "smoothEmaTime"
  smoothEmaTime: Int!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type ProtocolFeeRatioChanged @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "value"
  value: Int!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type IsMarketAllowedChanged @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "market"
  market: String!
  "isMarketAllowed"
  isMarketAllowed: Boolean!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type FundingPaid @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "fundingRateX96"
  fundingRateX96: BigInt!
  "elapsedSec"
  elapsedSec: Int!
  "premiumX96"
  premiumX96: BigInt!
  "markPriceX96"
  markPriceX96: BigInt!
  "cumBasePerLiquidityX96"
  cumBasePerLiquidityX96: BigInt!
  "cumQuotePerLiquidityX96"
  cumQuotePerLiquidityX96: BigInt!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type LiquidityAddedMarket @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "base"
  base: BigInt!
  "quote"
  quote: BigInt!
  "liquidity"
  liquidity: BigInt!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type LiquidityRemovedMarket @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "base"
  base: BigInt!
  "quote"
  quote: BigInt!
  "liquidity"
  liquidity: BigInt!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type Swapped @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "isBaseToQuote"
  isBaseToQuote: Boolean!
  "isExactInput"
  isExactInput: Boolean!
  "amount"
  amount: BigInt!
  "oppositeAmount"
  oppositeAmount: BigInt!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type PoolFeeRatioChanged @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "value"
  value: Int!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type FundingMaxPremiumRatioChanged @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "value"
  value: Int!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type FundingMaxElapsedSecChanged @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "value"
  value: Int!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type FundingRolloverSecChanged @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "value"
  value: Int!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type PriceLimitConfigChanged @entity {
  "format: <tx hash>-<tx log index>"
  id: ID!

  "transaction hash"
  txHash: String!
  "normalOrderRatio"
  normalOrderRatio: Int!
  "liquidationRatio"
  liquidationRatio: Int!
  "emaNormalOrderRatio"
  emaNormalOrderRatio: Int!
  "emaLiquidationRatio"
  emaLiquidationRatio: Int!
  "emaSec"
  emaSec: Int!

  "(block number * 1000 + tx log index) for sorting"
  blockNumberLogIndex: BigInt!
  "block number"
  blockNumber: BigInt!
  "block timestamp"
  timestamp: BigInt!
}

type Trader @entity {
  "format: trader address"
  id: ID!

  "collateralBalance"
  collateralBalance: BigInt!
  "markets"
  markets: [String]!

  "last updated block number"
  blockNumber: BigInt!
  "last updated block timestamp"
  timestamp: BigInt!
}

type TraderTakerInfo @entity {
  "format: <trader address>-<market address>"
  id: ID!

  "trader address"
  trader: String!
  "market address"
  market: String!
  "baseBalanceShare"
  baseBalanceShare: BigInt!
  "baseBalance"
  baseBalance: BigInt!
  "quoteBalance"
  quoteBalance: BigInt!

  "last updated block number"
  blockNumber: BigInt!
  "last updated block timestamp"
  timestamp: BigInt!

  "positions"
  positions: [Position!]! @derivedFrom(field: "traderTakerInfoRef")

  dayData: [TraderDayData!] @derivedFrom(field: "trader")
}

type TraderMakerInfo @entity {
  "format: <trader address>-<market address>"
  id: ID!

  "trader address"
  trader: String!
  "market address"
  market: String!
  "baseDebtShare"
  baseDebtShare: BigInt!
  "baseDebtBalance"
  baseDebtBalance: BigInt!
  "quoteDebt"
  quoteDebt: BigInt!
  "liquidity"
  liquidity: BigInt!
  "cumBaseSharePerLiquidityX96"
  cumBaseSharePerLiquidityX96: BigInt!
  "cumQuotePerLiquidityX96"
  cumQuotePerLiquidityX96: BigInt!

  "last updated block number"
  blockNumber: BigInt!
  "last updated block timestamp"
  timestamp: BigInt!

  "open orders"
  openOrders: [OpenOrder!]! @derivedFrom(field: "traderMakerInfoRef")
}

type Protocol @entity {
  "hardcoded as 'perpdex'"
  id: ID!

  "network name"
  network: String!
  "chain id"
  chainId: String!
  "contract version"
  contractVersion: String!
  "number of public markets"
  publicMarketCount: BigInt!
  "cumulative trading volume"
  tradingVolume: BigInt!
  "total value locked"
  totalValueLocked: BigInt!
  "protocolFee"
  protocolFee: BigInt!
  "protocolFeeRatio"
  protocolFeeRatio: Int!
  "insuranceFundBalance"
  insuranceFundBalance: BigInt!
  "maxMarketsPerAccount"
  maxMarketsPerAccount: Int!
  "imRatio"
  imRatio: Int!
  "mmRatio"
  mmRatio: Int!
  "rewardRatio"
  rewardRatio: Int!
  "smoothEmaTime"
  smoothEmaTime: Int!

  "last updated block number"
  blockNumber: BigInt!
  "last updated block timestamp"
  timestamp: BigInt!
}

type Position @entity {
  "format: <trader address>-<market address>"
  id: ID!

  "trader address"
  trader: String!
  "market address"
  market: String!
  "baseShare"
  baseShare: BigInt!
  "baseBalance"
  baseBalance: BigInt!
  "average open notional after this tx"
  openNotional: BigInt!
  "average entry price of the current position = abs(openNotional / baseBalance)"
  entryPrice: BigInt!
  "realized pnl of this tx"
  realizedPnl: BigInt!
  "cumulative trading volume"
  tradingVolume: BigInt!

  "last updated block number"
  blockNumber: BigInt!
  "last updated block timestamp"
  timestamp: BigInt!

  "foreign key to traderTakerInfo"
  traderTakerInfoRef: TraderTakerInfo!
  "foreign key to Market"
  marketRef: Market!
}

type OpenOrder @entity {
  "format: <maker address>-<market address>"
  id: ID!
  "maker address"
  maker: String!
  "market address"
  market: String!
  "provided liquidity base"
  base: BigInt!
  "provided liquidity quote"
  quote: BigInt!
  "current liquidity"
  liquidity: BigInt!
  "realizedPnl"
  realizedPnl: BigInt!

  "last updated block number"
  blockNumber: BigInt!
  "last updated block timestamp"
  timestamp: BigInt!

  "foreign key to traderMakerInfo"
  traderMakerInfoRef: TraderMakerInfo!
  "foreign key to Market"
  marketRef: Market!
}

type Market @entity {
  "format: market address"
  id: ID!

  "baseToken address"
  baseToken: String!
  "quoteToken address"
  quoteToken: String!
  "cumulative trading volume"
  tradingVolume: BigInt!
  "provided liquidity base amount"
  baseAmount: BigInt!
  "provided liquidity quote amount"
  quoteAmount: BigInt!
  "total liquidity"
  liquidity: BigInt!
  "baseBalancePerShareX96"
  baseBalancePerShareX96: BigInt # wip
  "sharePriceAfterX96"
  sharePriceAfterX96: BigInt! # wip
  "markPriceX96"
  markPriceX96: BigInt!
  "cumBasePerLiquidityX96"
  cumBasePerLiquidityX96: BigInt!
  "cumQuotePerLiquidityX96"
  cumQuotePerLiquidityX96: BigInt!
  "poolFeeRatio"
  poolFeeRatio: Int!
  "maxPremiumRatio"
  maxPremiumRatio: Int!
  "fundingMaxElapsedSec"
  fundingMaxElapsedSec: Int!
  "fundingRolloverSec"
  fundingRolloverSec: Int!
  "normalOrderRatio"
  normalOrderRatio: Int!
  "liquidationRatio"
  liquidationRatio: Int!
  "emaNormalOrderRatio"
  emaNormalOrderRatio: Int!
  "emaLiquidationRatio"
  emaLiquidationRatio: Int!
  "emaSec"
  emaSec: Int!

  "block number when the pool was added "
  blockNumberAdded: BigInt!
  "block timestamp when the pool was added "
  timestampAdded: BigInt!
  "last updated block number"
  blockNumber: BigInt!
  "last updated block timestamp"
  timestamp: BigInt!

  "positions"
  positions: [Position!]! @derivedFrom(field: "marketRef")
  "open orders"
  openOrders: [OpenOrder!]! @derivedFrom(field: "marketRef")
}

type Candle @entity {
  "format: <market address>-<timeFormat>-"
  id: ID!

  "market address"
  market: String!
  "time format"
  # examples of timeformat: 300(5m), 86400(=1d)
  timeFormat: Int!

  "ohlcs"
  ohlcs: [OHLC] @derivedFrom(field: "candle")

  "last updated block number"
  blockNumber: BigInt!
  "last updated block timestamp"
  timestamp: BigInt!
}

type OHLC @entity {
  "format: <market address>-<time>-"
  id: ID!

  "market address"
  market: String!
  "time"
  time: Date!

  "open"
  open: BigInt!
  "high"
  high: BigInt!
  "low"
  low: BigInt!
  "close"
  close: BigInt!

  "candle"
  candle: Candle

  "last updated block number"
  blockNumber: BigInt!
  "last updated block timestamp"
  timestamp: BigInt!
}

type TraderDayData @entity {
  "format: <trader id>-<day id>"
  id: ID!

  trader: Trader!
  "timestamp"
  date: BigInt!
  "trading volume aggregated per day for trader"
  tradingVolume: BigInt!
  "total pnl aggregated per day for trader"
  realizedPnl: BigInt!

  "last updated block number"
  blockNumber: BigInt!
  "last updated block timestamp"
  timestamp: BigInt!
}
